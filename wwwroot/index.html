<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Samurai ICQ</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    :root {
      --accent: #ff0055;
      --accent2:#ff3366;
      --bgDark: rgba(0,0,0,0.85);
      --panel: rgba(0,0,0,0.7);
    }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      /* Saƒülam arka plan: g√∂rsel yok, gradient */
      background: linear-gradient(135deg, #1f1c2c 0%, #302b63 50%, #24243e 100%);
      color: #fff;
    }

    /* ==== Login ==== */
    #loginScreen {
      background: var(--bgDark);
      width: 360px;
      padding: 28px;
      border-radius: 16px;
      box-shadow: 0 0 28px rgba(255,0,85,0.35);
      text-align: center;
      animation: fadeIn .4s ease;
    }
    #loginScreen .logo {
      font-size: 64px;
      margin-bottom: 8px;
      text-shadow: 0 0 8px var(--accent);
    }
    #loginScreen h2 {
      margin: 0 0 14px;
      font-weight: 700;
      letter-spacing: 0.5px;
      color: var(--accent);
    }
    #loginScreen input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: none;
      border-radius: 10px;
      background: #1e1e1e;
      color: #fff;
      text-align: center;
      font-size: 15px;
    }
    #loginScreen button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    #loginError { display:none; color:#ff6b6b; margin-top:8px; font-size: 14px; }

    /* ==== App ==== */
    #app {
      display: none;
      width: 100%;
      height: 100vh;
      padding: 12px;
      gap: 12px;
    }
    #sidebar {
      width: 280px;
      background: var(--bgDark);
      border: 2px solid var(--accent);
      border-radius: 14px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    #sidebar h3 {
      margin: 0 0 10px;
      text-align: center;
      color: var(--accent);
    }
    .sectionTitle { margin: 12px 0 6px; font-weight: 600; opacity: .9; }
    #users {
      flex: 1;
      overflow: auto;
      background: #151515;
      border-radius: 10px;
      padding: 8px;
      border: 1px solid #333;
    }
    .user {
      padding: 10px;
      margin: 6px 0;
      background: #232323;
      border-radius: 10px;
      cursor: pointer;
      transition: .15s;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .user::before {
      content:"";
      width:10px; height:10px;
      border-radius:50%;
      background:#2ecc71;
      box-shadow:0 0 8px #2ecc71;
      display:inline-block;
    }
    .user:hover { background:#333; }

    #rooms {
      background:#151515;
      border:1px solid #333;
      border-radius:10px;
      padding:8px;
    }
    .room {
      padding:10px;
      margin:6px 0;
      background:#232323;
      border-radius:10px;
      cursor:pointer;
      transition:.15s;
      text-align:center;
    }
    .room.active, .room:hover { background:#383838; }

    #main {
      flex: 1;
      min-width: 0;
      display:flex;
      flex-direction: column;
      background: var(--panel);
      border-radius: 14px;
      border: 1px solid #3a3a3a;
      overflow: hidden;
    }
    #chat {
      flex:1;
      overflow:auto;
      padding: 14px;
      background: rgba(0,0,0,.55);
    }
    .msg { margin:6px 0; }
    .msg b { color:#ffd1dc; }
    .sys { opacity:.8; font-style: italic; }
    #composer {
      padding: 10px;
      display:flex; gap:10px;
      border-top: 2px solid #2a2a2a;
      background:#121212;
    }
    #message {
      flex:1; padding:12px; border-radius:10px; border:none; outline:none;
      background:#1e1e1e; color:#fff;
      font-size:15px;
    }
    #sendBtn {
      padding:12px 16px; border:none; border-radius:10px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff; font-weight:600; cursor:pointer;
    }

    @keyframes fadeIn {
      from {opacity:0; transform: translateY(-6px);}
      to   {opacity:1; transform: translateY(0);}
    }
  </style>
</head>
<body>

  <!-- Gƒ∞Rƒ∞≈û -->
  <div id="loginScreen">
    <div class="logo">üó°Ô∏è</div>
    <h2>Samurai ICQ</h2>
    <input id="usernameInput" type="text" placeholder="Kullanƒ±cƒ± adƒ±" />
    <input id="passwordInput" type="password" placeholder="≈ûifre (12345)" />
    <button onclick="login()">Giri≈ü Yap</button>
    <div id="loginError">Hatalƒ± ≈üifre ya da bo≈ü kullanƒ±cƒ± adƒ±.</div>
  </div>

  <!-- APP -->
  <div id="app">
    <div id="sidebar">
      <h3>‚öî Samurai ICQ</h3>

      <div class="sectionTitle">Kullanƒ±cƒ±lar</div>
      <div id="users"></div>

      <div class="sectionTitle">Odalar</div>
      <div id="rooms">
        <div class="room active" onclick="joinRoom('Lobby')">Lobby</div>
        <div class="room" onclick="joinRoom('Samurai Room')">Samurai Room</div>
      </div>
    </div>

    <div id="main">
      <div id="chat"></div>
      <div id="composer">
        <input id="message" type="text" placeholder="Mesaj yaz..." />
        <button id="sendBtn" onclick="sendMessage()">G√∂nder</button>
      </div>
    </div>
  </div>

  <audio id="remoteAudio" autoplay></audio>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
  <script>
    // ====== Durum ======
    let username = "";
    let currentRoom = "Lobby";
    let connection;
    let peer;        // RTCPeerConnection
    let localStream; // mikrofon akƒ±≈üƒ±

    // ====== Login ======
    function login() {
      const u = document.getElementById("usernameInput").value.trim();
      const p = document.getElementById("passwordInput").value.trim();
      if (!u || p !== "12345") {
        document.getElementById("loginError").style.display = "block";
        return;
      }
      username = u;
      // UI ge√ßi≈üi
      document.getElementById("loginScreen").style.display = "none";
      document.body.style.alignItems = "stretch";
      document.body.style.justifyContent = "stretch";
      document.getElementById("app").style.display = "flex";

      // SignalR ba≈ülat
      startSignalR();
    }

    // ====== SignalR ======
    function startSignalR() {
      connection = new signalR.HubConnectionBuilder()
        .withUrl("/voicehub")
        .withAutomaticReconnect()
        .build();

      // Kullanƒ±cƒ± listesi: [{id,name,room}]
      connection.on("UpdateUserList", (userArr) => {
        const box = document.getElementById("users");
        box.innerHTML = "";
        userArr.forEach(u => {
          if (u.id === connection.connectionId) return; // kendini g√∂sterme
          const row = document.createElement("div");
          row.className = "user";
          row.textContent = `${u.name}${u.room ? " ‚Ä¢ " + u.room : ""}`;
          row.onclick = () => startCall(u.id);
          box.appendChild(row);
        });
      });

      // Mesajlar
      connection.on("ReceiveMessage", (from, text) => {
        appendMsg(from, text);
      });

      // WebRTC sinyalle≈üme
      connection.on("ReceiveOffer", async (callerId, offerJson) => {
        await ensureMic();
        createPeer(callerId);
        await peer.setRemoteDescription(new RTCSessionDescription(JSON.parse(offerJson)));
        const answer = await peer.createAnswer();
        await peer.setLocalDescription(answer);
        await connection.invoke("SendAnswer", callerId, JSON.stringify(answer));
      });

      connection.on("ReceiveAnswer", async (_callerId, answerJson) => {
        if (!peer) return;
        await peer.setRemoteDescription(new RTCSessionDescription(JSON.parse(answerJson)));
      });

      connection.on("ReceiveIceCandidate", async (_fromId, candJson) => {
        if (!peer || !candJson) return;
        try {
          await peer.addIceCandidate(new RTCIceCandidate(JSON.parse(candJson)));
        } catch(e) { console.warn("ICE eklenemedi:", e); }
      });

      connection.start()
        .then(async () => {
          // ƒ∞smi kaydet ve odaya katƒ±l
          await connection.invoke("Register", username);
          await connection.invoke("JoinRoom", currentRoom);
          appendSys(`"${currentRoom}" odasƒ±na katƒ±ldƒ±n. Mesaj yazmaya ba≈ülayabilirsin.`);
          // Enter ile g√∂nder
          document.getElementById("message").addEventListener("keydown", (e) => {
            if (e.key === "Enter") sendMessage();
          });
        })
        .catch(err => {
          console.error("SignalR baƒülantƒ± hatasƒ±:", err);
          appendSys("SignalR baƒülantƒ±sƒ± kurulamadƒ±. Konsolu kontrol edin.");
        });
    }

    // ====== Chat ======
    function sendMessage() {
      const input = document.getElementById("message");
      const text = input.value.trim();
      if (!text) return;
      connection.invoke("SendMessage", currentRoom, text);
      input.value = "";
    }

    function appendMsg(user, text) {
      const chat = document.getElementById("chat");
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `<b>${escapeHtml(user)}:</b> ${escapeHtml(text)}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function appendSys(text) {
      const chat = document.getElementById("chat");
      const div = document.createElement("div");
      div.className = "msg sys";
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ====== Odalar ======
    async function joinRoom(roomName) {
      currentRoom = roomName;
      // UI i≈üaretleme
      document.querySelectorAll(".room").forEach(r => r.classList.remove("active"));
      const match = Array.from(document.querySelectorAll(".room")).find(r => r.textContent === roomName);
      if (match) match.classList.add("active");
      // Sunucuya bildir
      try {
        await connection.invoke("JoinRoom", roomName);
      } catch (e) {
        console.error(e);
        appendSys("Odaya girerken hata oldu.");
      }
    }

    // ====== WebRTC (Ses) ======
    async function ensureMic() {
      if (localStream) return;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (e) {
        appendSys("Mikrofon izni verilmedi. L√ºtfen tarayƒ±cƒ±dan izin verin.");
        throw e;
      }
    }

    function createPeer(targetId) {
      // STUN ile daha stabil baƒülantƒ±
      peer = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      // Yerel ses
      localStream.getTracks().forEach(t => peer.addTrack(t, localStream));

      // ICE adaylarƒ±nƒ± g√∂nder
      peer.onicecandidate = e => {
        if (e.candidate) {
          connection.invoke("SendIceCandidate", targetId, JSON.stringify(e.candidate)).catch(console.error);
        }
      };

      // Uzak ses
      peer.ontrack = e => {
        const remote = document.getElementById("remoteAudio");
        remote.srcObject = e.streams[0];
      };
    }

    async function startCall(targetId) {
      try {
        await ensureMic();
        createPeer(targetId);
        const offer = await peer.createOffer();
        await peer.setLocalDescription(offer);
        await connection.invoke("SendOffer", targetId, JSON.stringify(offer));
        appendSys("√áaƒürƒ± g√∂nderildi. Kar≈üƒ± taraf kabul ederse ses baƒülanƒ±r.");
      } catch (e) {
        console.error(e);
        appendSys("√áaƒürƒ± ba≈ülatƒ±lamadƒ±. Mikrofon/izinleri kontrol edin.");
      }
    }
  </script>
</body>
</html>
